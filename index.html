<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MATOTA Online Eğitim</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>

    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: #0f172a;
            color: white;
            margin: 0;
            padding: 0;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- VİDEO ALANI (Scrollable) --- */
        main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        /* --- AKILLI GRİD SİSTEMİ --- */
        #video-grid {
            display: grid;
            gap: 12px;
            padding: 12px;
            width: 100%;
            height: 100%;
            overflow-y: auto; 
            
            /* Varsayılan Mod: Herkes Eşit Grid */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            grid-auto-rows: minmax(200px, 1fr);
            align-content: center;
            transition: all 0.3s ease;
        }

        /* --- GOOGLE MEET TARZI (SPOTLIGHT) --- */
        #video-grid.spotlight-mode {
            /* MASAÜSTÜ: 1. Kolon (Ekran) Esnek, 2. Kolon (Kameralar) Sabit 260px */
            display: grid;
            grid-template-columns: 1fr 260px; 
            /* Satırlar içeriğe göre otomatik, ama ilk satır (ekran) full boy */
            grid-template-rows: 1fr; 
            grid-auto-rows: 160px; /* Kameraların yüksekliği */
            align-content: start;
            grid-auto-flow: row dense;
        }

        /* Ekran Paylaşımı Kutusu (Özel Ayarlar) */
        .video-container.is-screen-share {
            border: 2px solid #3b82f6;
            background: #000;
            z-index: 10;
        }

        /* Spotlight Modunda Ekran Paylaşımı: SOL TARAFI KAPLA */
        #video-grid.spotlight-mode .video-container.is-screen-share {
            grid-column: 1 / 2; /* 1. Sütun */
            grid-row: 1 / 99;   /* Tüm satırları boydan boya kapla */
            height: 100%;       /* Yüksekliği doldur */
            position: sticky;   /* Scroll yaparken sabit kalsın */
            top: 0;
            min-height: 400px;
        }

        /* Spotlight Modunda Kameralar: SAĞ SÜTUNA HAPSET */
        #video-grid.spotlight-mode .video-container:not(.is-screen-share) {
            grid-column: 2 / 3; /* 2. Sütun (Sağ Şerit) */
            height: 160px;      /* Sabit yükseklik */
            width: 100%;
        }

        /* MOBİL UYUMU (Spotlight) */
        @media (max-width: 768px) {
            #video-grid.spotlight-mode {
                grid-template-columns: 1fr; /* Tek sütun */
                grid-template-rows: auto auto; 
                display: flex;
                flex-direction: column;
            }
            
            #video-grid.spotlight-mode .video-container.is-screen-share {
                height: 50vh; /* Ekranın yarısı */
                flex-shrink: 0;
            }

            #video-grid.spotlight-mode .video-container:not(.is-screen-share) {
                height: 120px; /* Alttaki kameralar */
                flex-shrink: 0;
            }
        }

        /* --- GENEL VİDEO STİLLERİ --- */
        .video-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #1e293b;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Varsayılan: Yüzler için doldur */
            transition: object-fit 0.3s ease;
        }
        
        /* Ekran paylaşımı videosu KESİNLİKLE sığdırılmalı (Google Meet gibi) */
        video.screen-content {
            object-fit: contain !important; 
            background-color: #000;
        }
        
        .mirror-mode { transform: scaleX(-1); }

        /* KAMERA KAPALI LOGOSU */
        .cam-placeholder {
            position: absolute;
            inset: 0;
            background-color: #111827;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2; 
            display: none; 
            padding: 10px;
        }

        .cam-placeholder img {
            width: 100%;
            height: 100%;
            max-width: 150px;
            object-fit: contain;
            opacity: 0.8;
        }

        .video-container.cam-off .cam-placeholder {
            display: flex;
        }
        
        .video-container.is-screen-share .cam-placeholder {
            display: none !important;
        }

        /* Buton Stilleri */
        .btn-active { @apply bg-gray-700 hover:bg-gray-600 text-white; }
        .btn-inactive { @apply bg-red-600 hover:bg-red-700 text-white border-red-600; }
        .btn-loading { opacity: 0.7; cursor: not-allowed; pointer-events: none; }

        /* Sidebar */
        #participants-sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #participants-sidebar.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Yükleme Ekranı -->
    <div id="loader" class="fixed inset-0 z-[60] bg-gray-900 flex items-center justify-center">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-400 text-sm">MATOTA Hazırlanıyor...</p>
        </div>
    </div>

    <!-- 1. LOBİ -->
    <div id="lobby-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-[#0f172a] hidden">
        <div class="text-center mb-6 animate-float">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-600 to-indigo-600 shadow-lg shadow-indigo-500/30 mb-4">
                <i class="fas fa-graduation-cap text-2xl text-white"></i>
            </div>
            <h1 id="app-title-display" class="text-3xl md:text-4xl font-bold tracking-tight text-white"></h1>
            <p id="welcome-msg-display" class="text-gray-400 mt-2 text-xs md:text-sm max-w-md mx-auto leading-relaxed"></p>
        </div>

        <div class="glass-panel w-full max-w-4xl rounded-3xl p-2 flex flex-col md:flex-row shadow-2xl overflow-hidden">
            <div class="w-full md:w-1/2 bg-black/40 rounded-2xl overflow-hidden relative aspect-video group">
                <video id="local-preview" autoplay muted playsinline class="w-full h-full object-cover mirror-mode"></video>
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-3 p-2 bg-black/60 backdrop-blur rounded-2xl border border-white/10 z-20">
                    <button id="prev-mic-btn" class="w-10 h-10 rounded-xl bg-gray-700 hover:bg-gray-600 text-white transition flex items-center justify-center"><i class="fas fa-microphone"></i></button>
                    <button id="prev-cam-btn" class="w-10 h-10 rounded-xl bg-gray-700 hover:bg-gray-600 text-white transition flex items-center justify-center"><i class="fas fa-video"></i></button>
                </div>
            </div>

            <div class="w-full md:w-1/2 p-6 flex flex-col justify-center gap-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider ml-1">Kullanıcı Adı</label>
                    <input type="text" id="nickname-input" class="w-full mt-1 bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider ml-1">Oda Kodu</label>
                    <input type="text" id="room-input" placeholder="ör: matematik" class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-purple-500 focus:outline-none transition font-mono text-sm">
                    <p class="text-[10px] text-gray-500 mt-1 ml-1">* Oda kodu otomatik küçük harfe çevrilir.</p>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <button id="create-btn" class="group relative px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-semibold transition overflow-hidden">
                        <span id="btn-create-text" class="relative flex items-center justify-center gap-2 text-sm"><i class="fas fa-chalkboard-teacher"></i> Kur (Hoca)</span>
                    </button>
                    <button id="join-btn" class="px-4 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-xl text-white font-semibold transition">
                        <span id="btn-join-text" class="flex items-center justify-center gap-2 text-sm"><i class="fas fa-user-graduate"></i> Katıl (Öğrenci)</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ODA -->
    <div id="room-screen" class="hidden h-full w-full flex flex-col relative overflow-hidden">
        <header class="h-14 glass-panel border-b border-white/5 flex items-center justify-between px-4 z-20 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-video text-xs"></i>
                </div>
                <div>
                    <h2 id="room-title" class="font-bold text-white text-sm leading-tight">MATOTA</h2>
                    <div class="flex items-center gap-1.5 text-[10px] text-gray-400">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> <span id="conn-status">Bağlantı Kuruluyor...</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleParticipants()" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs text-gray-300 border border-white/10 transition flex items-center gap-2 relative">
                    <i class="fas fa-users"></i> 
                    <span class="hidden sm:inline">Katılımcılar</span>
                    <span id="participant-count" class="bg-red-500 text-white text-[8px] rounded-full px-1.5 py-0.5 absolute -top-1 -right-1">1</span>
                </button>
                <button onclick="copyLink()" class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs text-gray-300 border border-white/10 transition flex items-center gap-2">
                    <i class="fas fa-link"></i> <span class="hidden sm:inline">Link</span>
                </button>
            </div>
        </header>

        <main class="flex-1 w-full relative overflow-hidden bg-[#0b1120]">
            <div id="video-grid"></div>
        </main>

        <footer class="h-16 flex items-center justify-center gap-4 pb-2 shrink-0 z-30">
            <div class="glass-panel px-4 py-2 rounded-2xl flex items-center gap-3 shadow-2xl border border-white/10">
                <button id="toggle-mic" class="w-10 h-10 rounded-xl btn-active transition flex items-center justify-center text-lg"><i class="fas fa-microphone"></i></button>
                <button id="toggle-cam" class="w-10 h-10 rounded-xl btn-active transition flex items-center justify-center text-lg"><i class="fas fa-video"></i></button>
                <div class="w-px h-6 bg-gray-600 mx-1"></div>
                <button id="share-screen" class="w-10 h-10 rounded-xl bg-gray-700 hover:bg-blue-600 text-white transition flex items-center justify-center text-lg"><i class="fas fa-desktop"></i></button>
                <button id="leave-btn" class="w-12 h-10 rounded-xl bg-red-600 hover:bg-red-700 text-white transition flex items-center justify-center text-lg shadow-lg shadow-red-900/20"><i class="fas fa-phone-slash"></i></button>
            </div>
        </footer>

        <div id="participants-sidebar" class="absolute top-14 bottom-16 right-0 w-64 bg-[#0f172a]/95 backdrop-blur-xl border-l border-white/10 z-40 p-4 flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                <h3 class="font-bold text-sm">Katılımcılar</h3>
                <button onclick="toggleParticipants()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="participants-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <script>
        // CONFIG
        let config = {
            appTitle: "MATOTA Online Eğitim",
            teacherName: "Mustafa Kemal",
            defaultRoom: "Matematik",
            theme: { backgroundGradient: "radial-gradient(at 50% 0%, #1e1b4b 0, #0f172a 70%)" },
            messages: { 
                welcome: "Merhabalar! Premium Eğitim Platformu MATOTA'da Derse Hoş Geldiniz.", 
                teacherLabel: "Eğitmen", 
                studentLabel: "Öğrenci" 
            }
        };

        const state = { 
            localStream: null, 
            screenStream: null,
            screenCalls: [], 
            peer: null, 
            activeCalls: {},
            dataConnections: {}, 
            roomName: '',
            nickname: '',
            isTeacher: false,
            isMicOn: true,
            isCamOn: true,
            participants: [] 
        };

        const els = {
            loader: document.getElementById('loader'),
            lobby: document.getElementById('lobby-screen'),
            room: document.getElementById('room-screen'),
            videoGrid: document.getElementById('video-grid'),
            localPreview: document.getElementById('local-preview'),
            nickInput: document.getElementById('nickname-input'),
            roomInput: document.getElementById('room-input'),
            appTitle: document.getElementById('app-title-display'),
            welcomeMsg: document.getElementById('welcome-msg-display'),
            btnCreate: document.getElementById('create-btn'),
            btnJoin: document.getElementById('join-btn'),
            btnCreateText: document.getElementById('btn-create-text'),
            btnJoinText: document.getElementById('btn-join-text'),
            btnMic: document.getElementById('toggle-mic'),
            btnCam: document.getElementById('toggle-cam'),
            prevMic: document.getElementById('prev-mic-btn'),
            prevCam: document.getElementById('prev-cam-btn'),
            btnScreen: document.getElementById('share-screen'),
            btnLeave: document.getElementById('leave-btn'),
            roomTitle: document.getElementById('room-title'),
            status: document.getElementById('conn-status'),
            sidebar: document.getElementById('participants-sidebar'),
            pList: document.getElementById('participants-list'),
            pCount: document.getElementById('participant-count')
        };

        // SETUP
        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                if (response.ok) {
                    const jsonConfig = await response.json();
                    config = { ...config, ...jsonConfig };
                }
            } catch (e) {}
            
            document.title = config.appTitle;
            els.appTitle.innerText = config.appTitle;
            els.welcomeMsg.innerText = config.messages.welcome;
            els.nickInput.placeholder = `Örn: ${config.teacherName}`;
            els.roomInput.value = config.defaultRoom;
            if(config.theme.backgroundGradient) document.body.style.backgroundImage = config.theme.backgroundGradient;
            els.loader.style.display = 'none';
            els.lobby.classList.remove('hidden');
        }

        async function getMediaStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                state.localStream = stream;
                els.localPreview.srcObject = stream;
                els.localPreview.muted = true;
                updateButtonUI(els.btnMic, true, 'fa-microphone', 'fa-microphone-slash');
                updateButtonUI(els.btnCam, true, 'fa-video', 'fa-video-slash');
                return true;
            } catch (err) { return false; }
        }

        function updateButtonUI(btn, isActive, iconOn, iconOff) {
            const i = btn.querySelector('i');
            if (isActive) {
                btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'border-red-600');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                if(i) i.className = `fas ${iconOn}`;
            } else {
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                btn.classList.add('bg-red-600', 'hover:bg-red-700', 'border-red-600');
                if(i) i.className = `fas ${iconOff}`;
            }
        }

        // --- GİRİŞ MASKESİ ---
        els.roomInput.addEventListener('input', (e) => {
            let val = e.target.value.toLowerCase();
            val = val.replace(/ı/g, 'i').replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's').replace(/ö/g, 'o').replace(/ç/g, 'c');
            e.target.value = val.replace(/[^a-z0-9]/g, '');
        });

        // PEER & SESSION
        async function startSession(asTeacher) {
            const btn = asTeacher ? els.btnCreate : els.btnJoin;
            const btnText = asTeacher ? els.btnCreateText : els.btnJoinText;
            const originalText = btnText.innerHTML;
            
            btn.classList.add('btn-loading');
            btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';

            let roomVal = els.roomInput.value.toLowerCase().replace(/[^a-z0-9]/g, '');
            const nickVal = els.nickInput.value.trim() || (asTeacher ? config.teacherName : "Misafir");

            if (!roomVal) {
                alert("Kod yanlış lütfen doğru kodu giriniz.");
                resetButton(btn, btnText, originalText);
                return;
            }

            if (!state.localStream) {
                const hasPermission = await getMediaStream();
                if (!hasPermission) {
                    alert("Kamera ve mikrofon izni vermeden derse katılamazsınız.");
                    resetButton(btn, btnText, originalText);
                    return;
                }
            }

            state.roomName = roomVal;
            state.nickname = nickVal;
            state.isTeacher = asTeacher;
            
            els.lobby.classList.add('hidden');
            els.room.classList.remove('hidden');
            els.roomTitle.innerText = `MATOTA / ${roomVal}`;

            updateParticipantsList('me', nickVal, asTeacher);
            addVideo(state.localStream, `${nickVal} (Sen)`, true, 'me', false);

            const prefix = config.teacherName.replace(/\s+/g, '').toUpperCase();
            let myId = asTeacher 
                ? `${prefix}_${roomVal}_HOST` 
                : `${prefix}_${roomVal}_GUEST_${Math.random().toString(36).substr(2, 6)}`;

            state.peer = new Peer(myId, { debug: 1 });

            state.peer.on('open', (id) => {
                els.status.innerText = asTeacher ? "Ders Başlatıldı" : "Derse Bağlanılıyor...";
                els.status.classList.add('text-green-400');
                if (!asTeacher) connectToHost(`${prefix}_${roomVal}_HOST`);
            });

            state.peer.on('connection', (conn) => {
                conn.on('open', () => {
                    state.dataConnections[conn.peer] = conn;
                });
                setupDataListener(conn);
            });

            // ARAMA ALMA
            state.peer.on('call', (call) => {
                const isScreenShare = call.metadata && call.metadata.type === 'screen';
                
                if(isScreenShare) {
                    call.answer(); 
                } else {
                    call.answer(state.localStream);
                }

                const guestName = asTeacher ? config.messages.studentLabel : config.messages.teacherLabel;
                
                call.on('stream', (remoteStream) => {
                    if (isScreenShare) {
                        addVideo(remoteStream, "Ekran Paylaşımı", false, `screen-${call.peer}`, true);
                    } else {
                        addVideo(remoteStream, guestName, false, call.peer, false);
                        updateParticipantsList(call.peer, guestName, false);
                    }
                });
                
                if (!isScreenShare) {
                    state.activeCalls[call.peer] = call;
                }
            });
            
            state.peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    alert("Bu oda kodu şu an kullanımda. 10 saniye bekleyip tekrar deneyin.");
                    location.reload();
                } else if (err.type === 'peer-unavailable') {
                    alert("Öğretmen henüz derse başlamadı veya oda kodu yanlış.");
                    resetUI();
                }
            });
        }

        function resetButton(btn, txtEl, originalTxt) {
            btn.classList.remove('btn-loading');
            txtEl.innerHTML = originalTxt;
        }

        function resetUI() {
            els.lobby.classList.remove('hidden');
            els.room.classList.add('hidden');
            resetButton(els.btnCreate, els.btnCreateText, '<i class="fas fa-chalkboard-teacher"></i> Kur (Hoca)');
            resetButton(els.btnJoin, els.btnJoinText, '<i class="fas fa-user-graduate"></i> Katıl (Öğrenci)');
            if(state.peer) state.peer.destroy();
        }

        function connectToHost(hostId) {
            const call = state.peer.call(hostId, state.localStream);
            call.on('stream', (remoteStream) => {
                addVideo(remoteStream, config.messages.teacherLabel, false, hostId, false);
                updateParticipantsList(hostId, config.messages.teacherLabel, true);
                els.status.innerText = "Canlı Yayın";
            });
            call.on('close', () => {
                document.getElementById(`vid-${hostId}`)?.remove();
                removeParticipant(hostId);
                alert("Öğretmen dersten ayrıldı.");
            });
            state.activeCalls[hostId] = call;

            const conn = state.peer.connect(hostId);
            conn.on('open', () => { state.dataConnections[hostId] = conn; });
            setupDataListener(conn);
        }

        function setupDataListener(conn) {
            conn.on('data', (data) => {
                if(data.type === 'kick') {
                    alert("Öğretmen tarafından dersten çıkarıldınız.");
                    location.reload();
                }
                if(data.type === 'cam-status') {
                    togglePeerVideoPlaceholder(conn.peer, data.enabled);
                }
            });
        }

        function broadcastData(data) {
            Object.values(state.dataConnections).forEach(conn => {
                if (conn.open) conn.send(data);
            });
        }

        function togglePeerVideoPlaceholder(peerId, isEnabled) {
            const container = document.getElementById(`vid-${peerId}`);
            if (container) {
                if (isEnabled) container.classList.remove('cam-off');
                else container.classList.add('cam-off');
            }
        }

        // --- UI ---
        function updateParticipantsList(id, name, isTeacherPeer) {
            if (state.participants.some(p => p.id === id)) return;
            state.participants.push({ id, name, isTeacherPeer });
            renderParticipants();
        }

        function removeParticipant(id) {
            state.participants = state.participants.filter(p => p.id !== id);
            renderParticipants();
        }

        function renderParticipants() {
            els.pCount.innerText = state.participants.length;
            els.pList.innerHTML = '';
            state.participants.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white/5 p-2 rounded-lg text-xs';
                const left = document.createElement('div');
                left.className = 'flex items-center gap-2';
                left.innerHTML = `<i class="fas fa-user-circle text-gray-400"></i> <span>${p.name} ${p.id === 'me' ? '(Sen)' : ''}</span>`;
                item.appendChild(left);
                if (state.isTeacher && p.id !== 'me') {
                    const kickBtn = document.createElement('button');
                    kickBtn.className = 'text-red-500 hover:text-red-400 p-1';
                    kickBtn.innerHTML = '<i class="fas fa-times"></i>';
                    kickBtn.onclick = () => kickUser(p.id);
                    item.appendChild(kickBtn);
                }
                els.pList.appendChild(item);
            });
        }

        function kickUser(peerId) {
            if(!confirm("Bu kullanıcıyı atmak istiyor musunuz?")) return;
            const conn = state.dataConnections[peerId];
            if (conn && conn.open) conn.send({ type: 'kick' });
            if (state.activeCalls[peerId]) state.activeCalls[peerId].close();
            document.getElementById(`vid-${peerId}`)?.remove();
            removeParticipant(peerId);
            updateLayout();
        }

        // --- EKRAN PAYLAŞIMI ---
        els.btnScreen.addEventListener('click', async () => {
            if (state.screenStream) {
                // DURDUR
                state.screenStream.getTracks().forEach(track => track.stop());
                state.screenStream = null;
                els.btnScreen.classList.remove('bg-blue-600', 'text-white');
                els.btnScreen.classList.add('bg-gray-700');
                
                const screenDiv = document.getElementById('vid-myscreen');
                if(screenDiv) screenDiv.remove();

                state.screenCalls.forEach(call => call.close());
                state.screenCalls = [];
                
                updateLayout();

            } else {
                // BAŞLAT
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ cursor: true });
                    state.screenStream = stream;
                    const screenTrack = stream.getVideoTracks()[0];
                    screenTrack.onended = () => els.btnScreen.click();
                    
                    els.btnScreen.classList.remove('bg-gray-700');
                    els.btnScreen.classList.add('bg-blue-600', 'text-white');
                    
                    addVideo(stream, "Ekran Paylaşımı (Sen)", true, 'myscreen', true);
                    
                    state.participants.forEach(p => {
                        if (p.id !== 'me') {
                            const call = state.peer.call(p.id, stream, { 
                                metadata: { type: 'screen' } 
                            });
                            state.screenCalls.push(call);
                        }
                    });

                } catch (err) {
                    console.error(err);
                }
            }
        });

        // --- GRID DÜZENİ GÜNCELLEME (GELİŞMİŞ SPOTLIGHT) ---
        function updateLayout() {
            const grid = els.videoGrid;
            const screenShareEl = grid.querySelector('.is-screen-share');
            
            if (screenShareEl) {
                grid.classList.add('spotlight-mode');
            } else {
                grid.classList.remove('spotlight-mode');
                
                // Normal Grid
                const children = grid.children.length;
                grid.style.gridTemplateColumns = `repeat(auto-fit, minmax(300px, 1fr))`;
                grid.style.gridTemplateRows = `repeat(auto-fit, minmax(200px, 1fr))`;
            }
        }

        function addVideo(stream, label, isMuted, id, isScreenShare) {
            if(document.getElementById(`vid-${id}`)) return;
            const div = document.createElement('div');
            div.className = 'video-container animate-fade-in group';
            div.id = `vid-${id}`;
            
            if (isScreenShare) {
                div.classList.add('is-screen-share');
            }
            
            const placeholder = document.createElement('div');
            placeholder.className = 'cam-placeholder';
            placeholder.innerHTML = `
                <img src="https://r.resimlink.com/ZmxWCl-R70.png" class="animate-pulse">
                <span class="text-gray-400 text-xs font-semibold tracking-wider">KAMERA KAPALI</span>
            `;

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if (isMuted) video.muted = true;
            
            if (id === 'me' && !isScreenShare) video.classList.add('mirror-mode');
            
            if (isScreenShare) video.classList.add('screen-content');

            const tag = document.createElement('div');
            tag.className = 'absolute bottom-2 left-2 bg-black/60 backdrop-blur-md px-3 py-1 rounded-lg text-xs font-medium border border-white/10 text-white flex items-center gap-2 z-10';
            tag.innerHTML = `<i class="fas fa-${isScreenShare ? 'desktop' : 'user'} text-[10px] text-blue-400"></i> ${label}`;

            div.appendChild(video);
            if (!isScreenShare) div.appendChild(placeholder);
            div.appendChild(tag);
            els.videoGrid.appendChild(div);
            updateLayout();
        }

        window.toggleParticipants = () => els.sidebar.classList.toggle('open');

        function toggleAudio() {
            if (!state.localStream) return;
            const audioTrack = state.localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                state.isMicOn = audioTrack.enabled;
                updateButtonUI(els.btnMic, state.isMicOn, 'fa-microphone', 'fa-microphone-slash');
                updateButtonUI(els.prevMic, state.isMicOn, 'fa-microphone', 'fa-microphone-slash');
            }
        }

        function toggleVideo() {
            if (!state.localStream) return;
            const videoTrack = state.localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                state.isCamOn = videoTrack.enabled;
                
                updateButtonUI(els.btnCam, state.isCamOn, 'fa-video', 'fa-video-slash');
                updateButtonUI(els.prevCam, state.isCamOn, 'fa-video', 'fa-video-slash');
                
                togglePeerVideoPlaceholder('me', state.isCamOn);
                broadcastData({ type: 'cam-status', enabled: state.isCamOn });
            }
        }

        els.btnCreate.addEventListener('click', () => startSession(true));
        els.btnJoin.addEventListener('click', () => startSession(false));
        els.btnMic.addEventListener('click', toggleAudio);
        els.prevMic.addEventListener('click', toggleAudio);
        els.btnCam.addEventListener('click', toggleVideo);
        els.prevCam.addEventListener('click', toggleVideo);
        
        window.copyLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?room=${state.roomName}`;
            navigator.clipboard.writeText(url);
            alert("Link Kopyalandı!");
        };

        els.btnLeave.addEventListener('click', () => location.reload());
        window.addEventListener("beforeunload", () => { if (state.peer) state.peer.destroy(); });
        window.addEventListener('load', () => { loadConfig(); getMediaStream(); });
    </script>
</body>
</html>
